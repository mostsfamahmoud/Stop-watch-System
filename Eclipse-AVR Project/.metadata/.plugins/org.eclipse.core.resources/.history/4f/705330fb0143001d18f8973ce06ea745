/*
 * timer.c
 *
 *  Created on: Oct 3, 2022
 *      Author: mosta
 */

#include "timer.h"


/*******************************************************************************
 *                            FUNCTIONS DEFINITIONS                            *
 *******************************************************************************/

void Timer1_CTC_Init(void)
{
	TCNT1 = 0;              /* Set timer1 initial count to zero */

	OCR1A = 977;            /* Set the Compare value to 977 ( To tigger an interrupt each second ) */

	TIMSK = (1 << OCIE1A);  /* Enable Timer1 Compare A Interrupt */

	/* Configure timer control register TCCR1A:
	 * 1. Clear OC1A/OC1B on compare match (Set output to low level)
	      COM1A1=1 COM1A0=0 COM1B0=0 COM1B1=1

	 * 2. FOC1A=1 FOC1B=0
	 * 3. CTC Mode WGM10=0 WGM11=0 (Mode Number 4)
	 */
	TCCR1A = (1 << FOC1A) | (1 << COM1A1);

	/* Configure timer control register TCCR1B:
	 * 1. CTC Mode WGM12=1 WGM13=0 (Mode Number 4)
	 * 2. Prescaler = F_CPU/1024
	      CS10=1 CS11=0 CS12=1
	 */
	TCCR1B = (1 << WGM12) | (1 << CS12) | (1 << CS10);
}



/*******************************************************************************
 *                          INTERRUPT SERVICE ROUTINES                         *
 *******************************************************************************/

ISR(TIMER1_COMPA_vect)
{
	g_Interrupt_Flag = 1;    /* Set this global interrupt flag as an indication of Timer1 interrupt */
}


/* INT0 (ISR) that is responsible for RESET the Stop-Watch timer */
ISR(INT0_vect)
{
	resetDigits();       /* Reset all Stop-Watch digits to start from the beginning again */

	PORTC &= 0xF0;       /* Clear all 7-Segment displays */

	_delay_ms(30);       /* Just a 30ms delay due to Button-debouncing */
}


/* INT1 (ISR) that is responsible for PAUSE the Stop-Watch timer */
ISR(INT1_vect)
{
	/* Configure timer control register TCCR1B:
	 * No clock source (Timer/Counter stopped)
	      CS10=0 CS11=0 CS12=0
	 */
	CLEAR_BIT(TCCR1B,CS10);
	CLEAR_BIT(TCCR1B,CS11);
	CLEAR_BIT(TCCR1B,CS12);
}


/* INT2 (ISR) that is responsible for RESUME the Stop-Watch timer if it is paused */
ISR(INT2_vect)
{
	/* Configure timer control register TCCR1B:
	 * Clock Source ON again (F_CLK/1024 (From prescaler))
	      CS10=1 CS11=0 CS12=1
	 */

	/* Check if bit (CS10) in register (TCCR1B) is cleared or not */
	if (BIT_IS_CLEAR(TCCR1B,CS10))
	{
		SET_BIT(TCCR1B,CS10);
	}

	/* Check if bit (CS12) in register (TCCR1B) is cleared or not */
	if (BIT_IS_CLEAR(TCCR1B,CS12))
	{
		SET_BIT(TCCR1B,CS12);
	}
}

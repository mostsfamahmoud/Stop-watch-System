/******************************************************************************
 * Module: StopWatch Main file
 * File Name: StopWatch.c
 * Description: Source file for The Stop Watch Main File.
 * Author: Mostafa Mahmoud
 * Group:  71
 * Created on: Sep 15, 2022
 *******************************************************************************/

#include <util/delay.h>
#include "gpio.h"
#include "External_Interrupts.h"
#include "timer.h"

/*******************************************************************************
 *                               GLOBAL VARIABLES                              *
 *******************************************************************************/

uint8_t g_Sec = 0;       /* Global variable that represent Seconds count */
uint8_t g_Min = 0;       /* Global variable that represent Minutes count */
uint8_t g_Hour = 0;      /* Global variable that represent Hours count */

/* Volatile --> To Stop Compiler Optimization as (flag is set by hardware event)
 * Flag to be Set if Timer1 interrupt is triggered
 */
volatile uint8_t g_Interrupt_Flag = 0;


/*******************************************************************************
 *                           FUNCTIONS PROTOTYPES                              *
 *******************************************************************************/


void StopWatch_Multiplexing_Mode(void);
void StopWatch_TimeProcessing(void);
void resetDigits(void);

/*******************************************************************************
 *                                MAIN FUNCTION                                *
 *******************************************************************************/

int main(void)
{
	GPIO_setPortDirection(PORTA_ID, 0x3F); /* Configure (PA0 ... PA5) as O/P pins (Control of the 7 Segment) */

	GPIO_setPortDirection(PORTC_ID, 0x0F); /* Configure (PC0 ... PC3) as O/P pins */

	Timer1_CTC_Init();    /* Initialize TIMER1 Compare mode */

	INT0_Init();          /* Initialize INT0 as RESET interrupt */
	INT1_Init();          /* Initialize INT1 as PAUSE interrupt */
	INT2_Init();          /* Initialize INT2 as RESUME interrupt */

	SET_BIT(SREG, I_BIT); /* Enable global interrupts in MC by setting I-bit */

	while (1)
	{
		StopWatch_Multiplexing_Mode();

		if (g_Interrupt_Flag == 1)
		{
			StopWatch_TimeProcessing();

			g_Interrupt_Flag = 0;     /* Clear flag to be Set when timer interrupt is triggered again */
		}
	}

	return 0;
}

/*******************************************************************************
 *                            FUNCTIONS DEFINITIONS                            *
 *******************************************************************************/


/* Function that implement the Multiplexing Mode.
 * Description:
 * One 7-segment display is driven by the Microcontroller at a time and the rest are OFF.
 * It keeps switching the displays using transistors.
 */
void StopWatch_Multiplexing_Mode(void)
{
	/* To get first digit of Seconds , Use g_Sec % 10
	 * To get second digit of Seconds , Use g_Sec / 10
	 * That technique is also applied on g_Min , g_Hour
	 */
	uint8_t timeDigits[] = {(g_Sec % 10),(g_Sec / 10),
			                (g_Min % 10),(g_Min / 10),
			                (g_Hour % 10),(g_Hour / 10)};      /* Array that contains the Stop-Watch digits */

	for(uint8_t count = 0; count < 6; count++)
	{

		PORTA = (1 << count);        /* Enable All 7-Segments (one at a time) */

		/* First:  Clearing the display each iteration
		 * Second: Displaying the corresponding count in the enabled 7-Segment
		 */
		PORTC = (PORTC & 0xF0) | timeDigits[count];

		_delay_ms(4);     /* Delay between each 7-segment enable to make the Stop-Watch display looks normal */
	}
}

void StopWatch_TimeProcessing(void)
{
	/* Check if Seconds exceeded the range (0 --> 59) or not */
	if (g_Sec == 59)
	{
		g_Sec = 0;       /* Clear Seconds if exceeded */
		g_Min++;         /* Increment Mintues */
	}
	else
		g_Sec++;         /* Increment Seconds if not exceeded */

	/* Check if Mintues exceeded the range (0 --> 59) or not */
	if (g_Min > 59)
	{
		g_Min = 0;      /* Clear Mintues if exceeded */
		g_Hour++;       /* Increment Hours */
	}

	/* Check if Hours exceeded the range (0 --> 23 in one day) or not */
	if (g_Hour > 23)
	{
		g_Hour = 0;    /* Clear Hours if exceeded */
		               /* This case is like a Reset operation when overflow occurs in Stop-Watch timer */
	}
}

/* Function to reset all Stop-Watch Digits */
void resetDigits(void)
{
	g_Sec = 0;
	g_Min = 0;
	g_Hour = 0;
}
